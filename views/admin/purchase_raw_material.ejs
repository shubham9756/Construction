<%-include('navbar.ejs')%>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  :root {
    --blue-header: #1a3da8;
    --orange-accent: #ff8a00;
    --purple-btn: orange;
  }
  body {background:#f8f9fa;font-family:"Segoe UI",sans-serif;}
  .card-wrap {max-width: 1200px;margin:20px auto;border:1px solid #ddd;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.08);}
  .top-title {background: linear-gradient(to right, #290566, #4b3f92, rgb(183, 121, 219));
color:#fff;font-weight:800;padding:10px 16px;font-size:16px;
    border-left:6px solid var(--orange-accent);display:flex;justify-content:space-between;align-items:center;}
  .top-title span {font-size:14px;font-weight:600;}
  table th, table td {font-size:13px;vertical-align: middle;}
  .btn-add {background:orange;color:black;font-weight:600;border:none;padding:6px 14px;box-shadow:0 3px 0 rgba(0,0,0,0.15);}
  /* .btn-add:hover {background:#e01383;} */
  .btn-purple {background:var(--purple-btn);color:#fff;border:none;font-weight:700;padding:10px 28px;margin-top:20px; color: black;}
  .signature-box {width:100%;max-width:250px;padding:6px;border:2px solid #111;border-radius:4px;background-color:#fff;font-size:13px;}
  .signature-section {border:1px solid #ddd;padding:20px;text-align:center;}
  .signature-section p {font-size:13px;font-weight:600;margin:6px 0;}
  input.form-control,
  textarea.form-control,
  select.form-select {
      border: 2px solid #000 !important;
      box-shadow: none !important;
  }
</style>
</head>
<body>

<div class="card-wrap">
  <div class="top-title">
    <div>PURCHASE RAW MATERIAL</div>
    <div><span></span> &nbsp; </div>
  </div>

  <div class="p-3">

  <!-- ✅ FULL FORM WRAPPED CORRECTLY -->
  <form action="/save_new_raw_material" method="post" enctype="multipart/form-data">

    <!-- Vendor & Details -->
    <div class="row mb-3">
      <div class="col-md-4">
        <label for="">VENDOR</label>
        <select class="form-control" name="vendor_info" required>
          <% vendor.forEach(function(v){ %>
            <option value="<%= v.vendor_id %>|<%= v.vendor_name %>"><%= v.vendor_name %></option>
          <% }) %>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">PURCHASE BILL DATE</label>
        <input type="date" class="form-control" name="purchase_date" value="2025-09-12">
      </div>
      <div class="col-md-4">
        <label class="form-label">PURCHASE TYPE</label>
        <select class="form-select" name="purchase_type">
          <option>STATE</option>
          <option>INTERSTATE</option>
        </select>
      </div>
    </div>

    <!-- Table -->
    <div class="table-responsive">
      <table class="table table-bordered text-center align-middle" id="productTable">
        <thead class="table-light">
          <tr>
            <th>RAW MATERIAL</th>
            <th>QTY</th>
            <th>UDM</th>
            <th>RATE</th>
            <th>DISCOUNT</th>
            <th>TAXABLE VALUE</th>
            <th>GST %</th>
            <th>TOTAL</th>
            <th>X</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <select class="form-select material-select" name="raw_material[]">
                <option value="">Select</option>
                <option value="cement">Cement</option>
                <option value="steel">Steel</option>
                <option value="sand">Sand</option>
              </select>
            </td>
            <td><input type="number" class="form-control text-end qty" name="qty[]"></td>
            <td><input type="text" class="form-control udm" name="udm[]"></td>
            <td><input type="number" class="form-control text-end rate" name="rate[]"></td>
            <td><input type="number" class="form-control text-end discount" name="discount[]"></td>
            <td><input type="number" class="form-control text-end taxable" name="taxable[]" readonly></td>
            <td><input type="number" class="form-control text-end gst" name="gst[]"></td>
            <td><input type="number" class="form-control text-end total" name="total[]" readonly></td>
            <td><button type="button" class="btn btn-sm btn-danger remove-row">X</button></td>
          </tr>
        </tbody>
      </table>
    </div>

    <button type="button" class="btn btn-add" id="addRow">Add More Product</button>

    <!-- Totals -->
    <div class="row mt-3">
      <div class="col-md-4 offset-md-8">
        <table class="table table-bordered">
          <tr>
            <td><b>TOTAL</b></td>
            <td><input type="number" id="totalAmount" class="form-control text-end" name="total_amount" value="0.00" readonly></td>
          </tr>
          <tr>
            <td><b>EXTRA CHARGES</b></td>
            <td><input type="number" id="extraCharges" class="form-control text-end" name="extra_charges" value="0.00"></td>
          </tr>
          <tr>
            <td><b>GRAND TOTAL</b></td>
            <td><input type="number" id="grandTotal" class="form-control text-end fw-bold" name="grand_total" value="0.00" readonly></td>
          </tr>
        </table>
      </div>
    </div>

    <!-- Other fields -->
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">E-WAY BILL NUMBER</label>
        <input type="text" class="form-control" name="eway_bill" placeholder="E-WAY BILL NUMBER">
      </div>
      <div class="col-md-6">
        <label class="form-label">NOTE:</label>
        <textarea class="form-control" name="note"></textarea>
      </div>
    </div>

    <!-- Signatures -->
    <div class="row text-center">
      <div class="col-md-6 signature-section">
        <input type="file" class="signature-box" name="employee_sign">
        <p>EMPLOYEE SIGNATURE</p>
        <select class="form-control" name="employee_name">
              <option>Select Employee</option>
              <% employee.forEach(function(emp){ %>
                <option value="<%= emp.employee_name %>"><%= emp.employee_name %></option>
              <% }) %>
            </select>
      </div>
      <div class="col-md-6 signature-section">
        <input type="file" class="signature-box" name="vendor_sign">
      <div>
  <p><strong>VENDOR SIGNATURE</strong></p>
  <select class="form-select" name="vendor_name">
    <% for (var i = 0; i < vendor.length; i++) { %>
      <option value="<%= vendor[i].vendor_id %>"><%= vendor[i].vendor_name %></option>
    <% } %>
  </select>
</div>

    </div>

    <div class="text-center">
      <button type="submit" class="btn btn-purple">SAVE PURCHASE BILL</button>
    </div>

  </form>
  <!-- ✅ FORM ENDS -->

  </div>
</div>

<script>
  const materials = {
    cement: {qty: 50, udm: "Bags", rate: 300, discount: 0, gst: 18},
    steel:  {qty: 100, udm: "Kg",   rate: 70,  discount: 5, gst: 18},
    sand:   {qty: 200, udm: "Cft",  rate: 40,  discount: 0, gst: 5}
  };

  // Add new row with name attributes
  document.getElementById("addRow").addEventListener("click", function() {
    const table = document.querySelector("#productTable tbody");
    const newRow = document.createElement("tr");
    newRow.innerHTML = `
      <td>
        <select class="form-select material-select" name="raw_material[]">
          <option value="">Select</option>
          <option value="cement">Cement</option>
          <option value="steel">Steel</option>
          <option value="sand">Sand</option>
        </select>
      </td>
      <td><input type="number" class="form-control text-end qty" name="qty[]"></td>
      <td><input type="text" class="form-control udm" name="udm[]"></td>
      <td><input type="number" class="form-control text-end rate" name="rate[]"></td>
      <td><input type="number" class="form-control text-end discount" name="discount[]"></td>
      <td><input type="number" class="form-control text-end taxable" name="taxable[]" readonly></td>
      <td><input type="number" class="form-control text-end gst" name="gst[]"></td>
      <td><input type="number" class="form-control text-end total" name="total[]" readonly></td>
      <td><button type="button" class="btn btn-sm btn-danger remove-row">X</button></td>
    `;
    table.appendChild(newRow);
  });

  // Autofill + calculations
  document.addEventListener("change", function(e) {
    if (e.target.classList.contains("material-select")) {
      const row = e.target.closest("tr");
      const value = e.target.value;
      if (materials[value]) {
        row.querySelector(".qty").value = materials[value].qty;
        row.querySelector(".udm").value = materials[value].udm;
        row.querySelector(".rate").value = materials[value].rate;
        row.querySelector(".discount").value = materials[value].discount;
        row.querySelector(".gst").value = materials[value].gst;
        calculateRow(row);
      }
    }
    if (e.target.classList.contains("qty") || 
        e.target.classList.contains("rate") || 
        e.target.classList.contains("discount") || 
        e.target.classList.contains("gst")) {
      calculateRow(e.target.closest("tr"));
    }
  });

  // Remove row
  document.addEventListener("click", function(e) {
    if (e.target && e.target.classList.contains("remove-row")) {
      e.target.closest("tr").remove();
      calculateTotal();
    }
  });

  function calculateRow(row) {
    const qty = parseFloat(row.querySelector(".qty").value) || 0;
    const rate = parseFloat(row.querySelector(".rate").value) || 0;
    const discount = parseFloat(row.querySelector(".discount").value) || 0;
    const gst = parseFloat(row.querySelector(".gst").value) || 0;

    let taxable = qty * rate - discount;
    row.querySelector(".taxable").value = taxable.toFixed(2);

    let total = taxable + (taxable * gst / 100);
    row.querySelector(".total").value = total.toFixed(2);

    calculateTotal();
  }

  function calculateTotal() {
    let total = 0;
    document.querySelectorAll(".total").forEach(input => {
      total += parseFloat(input.value) || 0;
    });
    document.getElementById("totalAmount").value = total.toFixed(2);

    const extra = parseFloat(document.getElementById("extraCharges").value) || 0;
    document.getElementById("grandTotal").value = (total + extra).toFixed(2);
  }

  document.getElementById("extraCharges").addEventListener("input", calculateTotal);
</script>

<%-include('footer.ejs')%>
