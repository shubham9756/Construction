<%-include('navbar.ejs')%>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Construction Management - Issue</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- DataTables CSS + Buttons -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">

  <style>
    body { background:#f7f5f8; }
    .page-header {
      background:#2b61b2; color:#fff; padding:12px 16px;
      border-radius:6px 6px 0 0; margin-bottom:14px;
    }
    .signature-pad {
      border:2px dashed #6c757d;
      width:100%;
      height:220px;
      cursor:crosshair;
      background:transparent;  
      border-radius:8px;
      display:block;
    }
    #signaturePadSection .card-body { padding: 8px !important; }
    .dt-controls {
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:12px; flex-wrap:wrap; gap:10px;
    }
    .dt-actions { display:flex; gap:8px; }
    .dt-actions .dt-button {
      background-color:#2b61b2 !important; color:#fff !important;
      border:0 !important; padding:.4rem .8rem !important; border-radius:.35rem !important;
    }
    .dt-actions .dt-button:hover { background-color:#244f98 !important; }
    .dt-button-collection { right:0 !important; left:auto !important; }
  </style>
</head>
<body>

<div class="container my-4">

  <!-- PRODUCT LIST -->
  <div class="card shadow-sm" id="productList">
    <div class="page-header"><h5 class="m-0">SELECT PRODUCT TO ISSUE</h5></div>
    <div class="card-body">
      <div class="dt-controls">
        <div class="dataTables_filter"></div>
        <div class="dt-actions"></div>
      </div>

      <div class="table-responsive">
        <table id="mainTable" class="table table-bordered table-striped align-middle mb-0">
          <thead class="table-primary text-center">
            <tr>
              <th>ISSUE</th>
              <th>SN</th>
              <th>MATERIAL</th>
              <th>UNIT UDM</th>
              <th>STOCK</th>
            </tr>
          </thead>
          <tbody>
            <tr class="text-center">
              <td><button class="btn btn-dark btn-sm" onclick="openIssueForm()">ISSUE</button></td>
              <td>1</td>
              <td>BRICKS</td>
              <td>15000 PCS</td>
              <td>14986</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ISSUE FORM -->
  <div id="issueForm" class="card shadow-sm mt-4 d-none">
    <div class="page-header"><h5 class="m-0">ISSUE 'BRICKS'</h5></div>
    <div class="card-body">
      <div class="row g-3 mb-3">
        <div class="col-md-4"><label class="form-label fw-bold">UNIT / UDM</label><input class="form-control"></div>
        <div class="col-md-4"><label class="form-label fw-bold">AVAIL STOCK</label><input class="form-control"></div>
        <div class="col-md-4"><label class="form-label fw-bold">ENTER QUANTITY TO ISSUE</label><input type="number" class="form-control"></div>
      </div>
      <div class="row g-3 mb-3">
        <div class="col-md-6"><label class="form-label fw-bold">SELECT SITE *</label><select class="form-select"><option>Select Site</option></select></div>
        <div class="col-md-6"><label class="form-label fw-bold">NOTE</label><textarea class="form-control"></textarea></div>
      </div>
      <div class="row g-3 mb-3">
        <div class="col-md-6"><label class="form-label fw-bold">SELECT EMPLOYEE *</label><select class="form-select"><option>Select Employee</option></select></div>
      </div>

      <div class="text-center mb-3">
        <button class="btn btn-warning fw-bold px-4 py-2" onclick="openSignaturePad()">Add Signature</button>
      </div>

      <div class="d-flex justify-content-end">
        <button class="btn btn-success">SAVE & ISSUE</button>
      </div>
    </div>
  </div>

  <!-- SIGNATURE PAD -->
  <div id="signaturePadSection" class="card shadow-sm mt-4 d-none">
    <div class="page-header"><h5 class="m-0">ADD SIGNATURE</h5></div>
    <div class="card-body text-center p-2">
      <canvas id="signatureCanvas" class="signature-pad d-block mx-auto mb-2"></canvas>

      <!-- Upload Signature Image -->
      <div class="mb-2">
        <input type="file" id="signatureUpload" accept="image/*" class="form-control form-control-sm w-auto mx-auto">
      </div>

      <div class="d-flex justify-content-center gap-2">
        <button class="btn btn-secondary btn-sm" onclick="clearSignature()">Clear</button>
        <button class="btn btn-warning btn-sm" onclick="saveSignature()">Save & Add Signature</button>
      </div>
    </div>
  </div>

</div>

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>

<script>
  $(document).ready(function () {
    $('#mainTable').DataTable({
      dom: '<"dt-controls"<"dataTables_filter"f><"dt-actions"B>>rtip',
      buttons: [
        { extend: 'colvis', text: 'Column Visibility' },
        { extend: 'csvHtml5', text: 'CSV', exportOptions: { columns: ':visible' } },
        { extend: 'print', text: 'Print', exportOptions: { columns: ':visible' } }
      ],
      language: { search: "", searchPlaceholder: "Search" },
      pageLength: 10
    });

    $('.dataTables_filter input').addClass('form-control form-control-sm');
  });

  function openIssueForm() {
    $("#issueForm").removeClass("d-none");
    $("#productList").addClass("d-none");
  }
  function openSignaturePad() {
    $("#issueForm").addClass("d-none");
    $("#signaturePadSection").removeClass("d-none");
  }
  function closeSignature() {
    $("#signaturePadSection").addClass("d-none");
    $("#issueForm").removeClass("d-none");
  }

  /* Signature Pad */
  const canvas = document.getElementById('signatureCanvas');
  const ctx = canvas.getContext('2d');
  let drawing = false;

  function resizeCanvas() {
    const ratio = window.devicePixelRatio || 1;
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    ctx.scale(ratio, ratio);
    ctx.lineJoin = ctx.lineCap = 'round';
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#000';
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    if (e.touches) return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
    return { x: e.clientX - rect.left, y: e.clientY - rect.top };
  }
  function startDraw(e) { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); e.preventDefault(); }
  function draw(e) { if (!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); }
  function endDraw() { drawing = false; ctx.closePath(); }

  canvas.addEventListener('mousedown', startDraw);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', endDraw);
  canvas.addEventListener('mouseleave', endDraw);
  canvas.addEventListener('touchstart', startDraw);
  canvas.addEventListener('touchmove', draw);
  canvas.addEventListener('touchend', endDraw);

  function clearSignature() { ctx.clearRect(0, 0, canvas.width, canvas.height); resizeCanvas(); }
  function saveSignature() { alert('Signature saved (demo)'); closeSignature(); }

  // Upload Signature Image
  document.getElementById("signatureUpload").addEventListener("change", function (e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (event) {
      const img = new Image();
      img.onload = function () {
        clearSignature();
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(file);
  });
</script>
</body>
</html>

<%-include('footer.ejs')%>