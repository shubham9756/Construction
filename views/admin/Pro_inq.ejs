<%-include('navbar.ejs')%>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>

<style>
/* SAME STYLES (no change) */
body { background: #f8f9fa; font-family: Arial, sans-serif; font-size: 16px; }
.container { max-width: 1300px; margin-top: 40px; }
.header { background: linear-gradient(to right, #FFD700 0.5%, #264db5 0.5%); color: #fff;
          font-weight: bold; padding: 15px 20px; font-size: 20px; text-transform: uppercase; border-radius: 5px; }
label { font-size: 14px; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
.form-control { border-radius: 0; font-size: 16px; padding: 8px; height: 45px; }
select.form-control { height: 45px; }
.btn-add, .btn-save, .btn-clear, .btn-remove { font-size: 16px; padding: 8px 20px; font-weight: bold; border-radius: 0; }
.btn-add { background: #ff1493; color: #fff; margin-top: 10px; }
.btn-save { background: #6f42c1; color: #fff; padding: 12px 30px; display: block; margin: 20px auto; }
.btn-clear { margin-top: 5px; font-size: 14px; padding: 5px 12px; }
.btn-remove { background: #444; color: #fff; padding: 5px 12px; }
.table-responsive { margin-top: 20px; }
#productTable input { height: 40px; font-size: 16px; }
#productTable th, #productTable td { vertical-align: middle; padding: 12px 8px; text-align: center; font-size: 16px; }
.text-end h5 { font-size: 18px; font-weight: bold; margin-top: 10px; }
.signature-box { border: 1px solid #a66be2; text-align: center; padding: 20px; height: auto; border-radius: 5px; }
.signature-box h5 { color: #6f42c1; font-weight: bold; margin-bottom: 10px; font-size: 16px; }
canvas { border: 1px solid #ccc; width: 100%; height: 150px; }
</style>

<div class="container mt-4">
  <div class="header">Processing Inquiries</div>

  <form action="/admin/save_inquiries" method="POST" enctype="multipart/form-data">
    <div class="row mt-3">
      <div class="col-md-6 mb-3">
        <select class="form-control" name="vendor_info" required>
          <% vendor.forEach(function(v){ %>
            <option value="<%= v.vendor_id %>|<%= v.vendor_name %>"><%= v.vendor_name %></option>
          <% }) %>
        </select>
      </div>
      <div class="col-md-3 mb-3">
        <label>Purchase Order Date</label>
        <input type="date" class="form-control" name="purchase_date" required>
      </div>
      <div class="col-md-3 mb-3">
        <label>Purchase Type</label>
        <select class="form-control" name="purchase_type" required>
          <option>State</option>
          <option>Interstate</option>
        </select>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered align-middle text-center" id="productTable">
        <thead class="table-light">
          <tr>
            <th>Raw Material</th>
            <th>QTY</th>
            <th>UDM</th>
            <th>Rate</th>
            <th>Discount</th>
            <th>Taxable Value</th>
            <th>GST %</th>
            <th>Total</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="text" class="form-control" name="raw_material[]" required></td>
            <td><input type="number" class="form-control qty" name="Material_qyt[]" required></td>
            <td><input type="text" class="form-control" name="udm[]"></td>
            <td><input type="number" class="form-control rate" name="rate[]"></td>
            <td><input type="number" class="form-control discount" name="discount[]"></td>
            <td><input type="number" class="form-control taxable" readonly name="Taxable_value[]"></td>
            <td><input type="number" class="form-control gst" name="gst[]"></td>
            <td><input type="number" class="form-control total" readonly name="total[]"></td>
            <td><button type="button" class="btn btn-remove btn-sm">X</button></td>
          </tr>
        </tbody>
      </table>
    </div>

    <button type="button" class="btn btn-add" id="addRow">Add More Product</button>

    <div class="text-end mt-2">
      <h5><b>Grand Total : <span id="grandTotal">0</span></b></h5>
    </div>

    <div class="row mt-3">
      <div class="col-md-4">
        <div class="signature-box">
          <h5>Add Signature</h5>
          <canvas id="signature-pad"></canvas>
          <input type="hidden" name="employee_sign" id="employee_sign">
          <button type="button" class="btn btn-danger btn-clear" id="clear-signature">Clear</button>

          <div class="mt-3">
            <label>Employee Signature</label>
            <select class="form-control" name="employee_signature">

              <option>Select Employee</option>
              <% employee.forEach(function(emp){ %>
                <option value="<%= emp.employee_name %>"><%= emp.employee_name %></option>
              <% }) %>
            </select>
          </div>
        </div>
      </div>
    </div>

    <button type="submit" class="btn btn-save">Save Purchase Bill</button>
  </form>
</div>

<script>
const canvas = document.getElementById("signature-pad");
const signaturePad = new SignaturePad(canvas);

document.getElementById("clear-signature").addEventListener("click", () => signaturePad.clear());

document.querySelector("form").addEventListener("submit", function() {
  document.getElementById("employee_sign").value = 
    signaturePad.isEmpty() ? "" : signaturePad.toDataURL();
});

function calculateRow(row) {
  let qty = parseFloat(row.querySelector(".qty").value) || 0;
  let rate = parseFloat(row.querySelector(".rate").value) || 0;
  let discount = parseFloat(row.querySelector(".discount").value) || 0;
  let gst = parseFloat(row.querySelector(".gst").value) || 0;

  let taxable = qty * rate - discount;
  let total = taxable + (taxable * gst / 100);

  row.querySelector(".taxable").value = taxable.toFixed(2);
  row.querySelector(".total").value = total.toFixed(2);
  calculateGrandTotal();
}

function calculateGrandTotal() {
  let total = 0;
  document.querySelectorAll(".total").forEach(input => total += parseFloat(input.value) || 0);
  document.getElementById("grandTotal").innerText = total.toFixed(2);
}

document.addEventListener("input", function(e) {
  if (["qty","rate","discount","gst"].some(cls => e.target.classList.contains(cls)))
    calculateRow(e.target.closest("tr"));
});

document.getElementById("addRow").addEventListener("click", function() {
  let table = document.querySelector("#productTable tbody");
  let newRow = table.rows[0].cloneNode(true);
  newRow.querySelectorAll("input").forEach(input => input.value = "");
  table.appendChild(newRow);
});

document.addEventListener("click", function(e) {
  if (e.target.classList.contains("btn-remove")) {
    let row = e.target.closest("tr");
    let table = document.querySelector("#productTable tbody");
    if (table.rows.length > 1) { row.remove(); calculateGrandTotal(); }
  }
});
</script>

<%-include('footer.ejs')%>
