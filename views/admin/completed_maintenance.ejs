<%-include("navbar.ejs")%>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet"/>
  <link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>

  <style>
    body { background: #f8f9fa; }
    .section-header {
      background: linear-gradient(90deg, #1e3c72, #2a5298);
      color: #fff;
      font-weight: bold;
      padding: 10px 15px;
      border-left: 6px solid gold;
    }
    .badge-success { background-color: green !important; }
    .deleteBtn { cursor: pointer; color: red; font-size: 1.2rem; }
    .deleteBtn:hover { color: darkred; }
  </style>
</head>
<body class="p-3">

<div class="container mt-5">
  <!-- MAIN TABLE CARD -->
  <div id="mainCard" class="card shadow-sm mb-3">
    <div class="section-header">COMPLETE MAINTENANCE</div>
    <div class="card-body">
      <div class="table-responsive">
        <table id="mainTable" class="table table-bordered table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>ACTION</th>
              <th>SN</th>
              <th>CUSTOMER NAME</th>
              <th>FLAT/SHOP NO.</th>
              <th>SITE</th>
              <th>AMOUNT</th>
              <th>RECEIVED</th>
              <th>MAINTENANCE DATE</th>
            </tr>
          </thead>
         <tbody>
            <tr data-id="1">
              <td><button class="btn btn-sm btn-dark viewBtn">VIEW</button></td>
              <td>1</td>
              <td>MANOJ MORE</td>
              <td>TAT2001</td>
              <td>NAYANTARA APARTMENT</td>
              <td>₹ 69,000/-</td>
              <td>₹ 69,000/-</td>
              <td>12 AUG 2025</td>
            </tr> 
            </tbody>

            <!-- <tr data-id="2">
              <td><button class="btn btn-sm btn-dark viewBtn">VIEW</button></td>
              <td>2</td>
              <td>RAVI PATIL</td>
              <td>TAT2002</td>
              <td>NAYANTARA APARTMENT</td>
              <td>₹ 75,000/-</td>
              <td>₹ 75,000/-</td>
              <td>15 AUG 2025</td>
            </tr>
          </tbody> --> 
        </table>
      </div>
    </div>
  </div>

  <!-- DETAILS CARD -->
  <div id="detailsCard" class="card shadow-sm d-none">
    <div class="section-header" id="detailsHeader">MAINTENANCE DETAILS</div>
    <div class="card-body">
      <div class="row g-3 mb-3">
        <div class="col-md-4">
          <label class="form-label">MAINTENANCE AMOUNT</label>
          <input type="text" class="form-control" id="amount">
        </div>
        <div class="col-md-4">
          <label class="form-label">MAINTENANCE DATE</label>
          <input type="date" class="form-control" id="date">
        </div>
        <div class="col-md-4">
          <label class="form-label">MAINTENANCE DETAILS</label>
          <input type="text" class="form-control" id="details">
        </div>
      </div>

      <div class="section-header">TRANSACTIONS</div>
      <div class="table-responsive mt-2">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>SN</th>
              <th>RECEIVED AMOUNT</th>
              <th>RECEIVED DATE</th>
              <th>RECEIVED BY</th>
              <th>AFTER TRANSACTION</th>
              <th>ACTION</th>
            </tr>
          </thead>
          <tbody id="transactionBody">
            <!-- Dynamic transaction rows -->
          </tbody>
        </table>
      </div>

      <div class="text-end">
        <button class="btn btn-primary">SHIFT TO PENDING MAINTENANCE</button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<!-- DataTables Buttons -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<script>
$(document).ready(function(){

  const transactions = {
    1: [
      { sn: 1, amount: "₹ 40,000/-", date: "10 AUG 2025", by: "UPI", after: "PENDING" },
      { sn: 2, amount: "₹ 29,000/-", date: "12 AUG 2025", by: "CASH", after: "PAID" }
    ],
    2: [
      { sn: 1, amount: "₹ 50,000/-", date: "13 AUG 2025", by: "CHEQUE", after: "PENDING" },
      { sn: 2, amount: "₹ 25,000/-", date: "15 AUG 2025", by: "UPI", after: "PAID" }
    ]
  };

  let currentId = null;

  $(document).on("click", ".viewBtn", function(){
    let row = $(this).closest("tr");
    currentId = row.data("id");
    let name = row.find("td:eq(2)").text().trim();
    let flat = row.find("td:eq(3)").text().trim();
    let amount = row.find("td:eq(5)").text().trim();
    let date = row.find("td:eq(7)").text().trim();

    $("#detailsHeader").html(
      `MAINTENANCE DETAILS OF <strong>${name}</strong> 
       <span class="badge bg-success">SOLD</span><br>
       FLAT/SHOP NO <strong>${flat}</strong>`
    );

    $("#amount").val("");
    $("#date").val(date);
    $("#details").val("");
    renderTransactions(currentId);

    $("#mainCard").hide();
    $("#detailsCard").removeClass("d-none");
  });

  function renderTransactions(id){
    let rows = "";
    transactions[id].forEach(tr => {
      rows += `
        <tr data-sn="${tr.sn}">
          <td>${tr.sn}</td>
          <td>${tr.amount}</td>
          <td>${tr.date}</td>
          <td>${tr.by}</td>
          <td>${tr.after}</td>
          <td><i class="fas fa-trash deleteBtn"></i></td>
        </tr>`;
    });
    $("#transactionBody").html(rows);
  }

  $(document).on("click", ".deleteBtn", function(){
    let trRow = $(this).closest("tr");
    let sn = trRow.data("sn");

    if(confirm("Are you sure you want to delete this transaction?")){
      transactions[currentId] = transactions[currentId].filter(t => t.sn !== sn);

      transactions[currentId] = transactions[currentId].map((t, index) => ({
        ...t, sn: index + 1
      }));

      renderTransactions(currentId);
    }
  });

  $('#mainTable').DataTable({
    dom: '<"d-flex justify-content-between mb-2"fB>rtip',
    buttons: [
      { extend: 'colvis', text: 'Column Visibility', className: 'btn btn-sm btn-secondary' },
      { extend: 'csv', text: 'CSV', className: 'btn btn-sm btn-secondary' },
      { 
        text: 'Print',
        className: 'btn btn-sm btn-secondary',
        action: function (e, dt, node, config) {
          let data = dt.buttons.exportData({
            columns: ':visible'
          });

          let tableHtml = '<table border="1" cellspacing="0" cellpadding="5"><thead><tr>';
          data.header.forEach(h => { tableHtml += <th>${h}</th>; });
          tableHtml += '</tr></thead><tbody>';
          data.body.forEach(row => {
            tableHtml += '<tr>';
            row.forEach(cell => { tableHtml += <td>${cell}</td>; });
            tableHtml += '</tr>';
          });
          tableHtml += '</tbody></table>';

          document.body.innerHTML = `
            <h2>Complete Maintenance Report</h2>
            <p>This is auto-generated report.</p>
            ${tableHtml}
            <p>Printed on: ${new Date().toLocaleDateString()}</p>
          `;
          window.print();
          location.reload();
        }
      }
    ]
  });

}); // ✅ Properly बंद केला
</script>


<%-include("footer.ejs")%>