<%-include('navbar.ejs')%>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .hidden { display: none; }
    .tab-btn { margin-right: 5px; }
    .adv-search-box {
      background: #f8f9fa;
      padding: 15px;
      border: 1px solid #ddd;
      margin-top: 10px;
      border-radius: 5px;
    }
    .btn-light-purple {
      background-color: #b388eb;
      color: white;
    }
    .btn-light-purple:hover {
      background-color: #9c6de0;
      color: white;
    }
    .btn-pink {
      background-color: #ff4081;
      color: white;
    }
    .btn-pink:hover {
      background-color: #e73370;
      color: white;
    }
  </style>
</head>
<body class="p-3">

<div class="container mt-5">

  <!-- Header -->
  <div id="flatHeader" class="d-flex justify-content-between align-items-center bg-primary text-white p-2">
    <h5 class="m-0">ALL SOLD AND RENTED FLAT LIST</h5>
    <button class="btn btn-light-purple text-white" onclick="toggleAdvSearch()">ADV SEARCH</button>
  </div>

  <!-- Advanced Search Form -->
  <div id="advSearchForm" class="adv-search-box hidden">
    <div class="row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label fw-bold">FROM</label>
        <input type="date" class="form-control" id="fromDate">
      </div>
      <div class="col-md-3">
        <label class="form-label fw-bold">TO</label>
        <input type="date" class="form-control" id="toDate">
      </div>
      <div class="col-md-3">
        <label class="form-label fw-bold">SELECT SITES</label>
        <select id="siteSelect" class="form-select">
          <option value="all">All</option>
          <option value="nayantara">Nayantara Apartment</option>
          <option value="kripa">Kripa Majestic</option>
          <option value="prathmesh">Prathmesh Elite</option>
        </select>
      </div>
      <div class="col-md-3">
        <!-- ✅ SEARCH पर onclick add किया -->
        <button class="btn btn-light-purple w-100" onclick="applySearch()">SEARCH</button>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div id="tabsDiv" class="mb-3 mt-3">
  <% for(var i=0 ; i<sites.length ; i++) { %>
    <a href="/check_maintenance/<%= sites[i].site_id %>" class="btn btn-primary">
      <%= sites[i].site_name %>
    </a>
  <% } %>
</div>


  <!-- Flats Table -->
  <table class="table table-bordered" id="flatTable">
    <thead>
        
      <tr>
        <th>SN</th>
        <th>FLAT/SHOP NO</th>
        <th>CUSTOMER NAME</th>
        <th>SQ. FEET</th>
        <th>SOLD OR RENT DATE</th>
        <th>LAST MAINTENANCE DATE</th>
        <th>LAST MAINTENANCE AMOUNT</th>
        <th>Select</th>
      </tr>
    </thead>
   <tbody id="flatBody">
  <% for(var i=0 ; i<flats.length ; i++) { %>
    <tr>
      <td><%= i+1 %></td>
      <td><%= flats[i].flat_name %></td>
      <td>
       
      </td>
      <td><%= flats[i].sq_feet %></td>
      <td><%= flats[i].sold_date %></td>
      <td><%= flats[i].last_maintenance_date %></td>
      <td><%= flats[i].last_maintenance_amount %></td>
      <td><input type="checkbox" /></td>
    </tr>
  <% } %>
</tbody>
    </table>

  <!-- Add Maintenance Button -->
  <div class="text-center mb-3 hidden" id="addBtnDiv">
    <button class="btn btn-light-purple" onclick="showForm()">ADD MAINTENANCE</button>
  </div>

  <!-- Add Maintenance Form -->
  <div id="maintenanceForm" class="hidden">
    <h5 class="bg-primary text-white p-2">ADD MAINTENANCE TO SELECTED FLAT</h5>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>FLAT/SHOP NO</th>
          <th>CUSTOMER NAME</th>
          <th>FLAT/SHOP SIZE</th>
          <th>SOLD AMOUNT</th>
          <th>RECEIVED AMOUNT</th>
          <th>SOLD DATE</th>
        </tr>
      </thead>
      <tbody id="formFlatRow"></tbody>
    </table>

    <div class="row mb-3">
      <div class="col-md-4">
        <label>ENTER MAINTENANCE AMOUNT *</label>
        <input type="number" class="form-control" id="maintAmount" placeholder="Enter amount">
      </div>
      <div class="col-md-4">
        <label>SELECT MAINTENANCE DATE *</label>
        <input type="date" class="form-control" id="maintDate">
      </div>
      <div class="col-md-4">
        <label>MAINTENANCE DETAILS</label>
        <input type="text" class="form-control" id="maintDetails" placeholder="Enter details">
      </div>
    </div>

    <button class="btn btn-pink" onclick="addMaintenance()">Add Maintenance</button>
  </div>
</div>

<script>
  const flats = {
    nayantara: [
      {sn:1, flat:'TAT2001', customer:'Manoj More', size:'2400/2000 SQFT', date:'2025-01-04', lastDate:'2025-08-12', amount:'₹ 69,000 /-', soldAmt:'₹ 14,02,814/-', recvAmt:'₹ 14,02,814/-'},
      {sn:2, flat:'TAT2002', customer:'Manoj More', size:'2200/2000 SQFT', date:'2025-08-12', lastDate:'NO MAINTENANCE', amount:'NULL', soldAmt:'₹ 12,50,000/-', recvAmt:'₹ 12,50,000/-'}
    ],
    kripa: [
      {sn:1, flat:'KM1001', customer:'Rahul Patil', size:'2000/1800 SQFT', date:'2025-02-15', lastDate:'NO MAINTENANCE', amount:'NULL', soldAmt:'₹ 10,00,000/-', recvAmt:'₹ 10,00,000/-'}
    ],
    prathmesh: [
      {sn:1, flat:'PE3001', customer:'Amit Deshmukh', size:'2500/2200 SQFT', date:'2025-03-20', lastDate:'NO MAINTENANCE', amount:'NULL', soldAmt:'₹ 15,00,000/-', recvAmt:'₹ 15,00,000/-'}
    ]
  };

  let selectedFlats = [];

  function toggleAdvSearch() {
    document.getElementById("advSearchForm").classList.toggle("hidden");
  }

  function showFlats(project) {
    const tbody = document.getElementById("flatBody");
    tbody.innerHTML = "";
    selectedFlats = [];
    flats[project].forEach(f => {
      tbody.innerHTML += `
        <tr>
          <td>${f.sn}</td>
          <td>${f.flat}</td>
          <td>${f.customer}</td>
          <td>${f.size}</td>
          <td>${f.date}</td>
          <td>${f.lastDate}</td>
          <td>${f.amount}</td>
          <td><input type="checkbox" onclick="toggleFlat('${project}', ${f.sn}, this)"></td>
        </tr>
      `;
    });
    document.getElementById("addBtnDiv").classList.add("hidden");
    document.getElementById("maintenanceForm").classList.add("hidden");
    document.getElementById("flatHeader").classList.remove("hidden");
    document.getElementById("tabsDiv").classList.remove("hidden");
    document.getElementById("flatTable").classList.remove("hidden");
  }

  function toggleFlat(project, sn, checkbox) {
    const flat = flats[project].find(f => f.sn === sn);
    if (checkbox.checked) {
      selectedFlats.push(flat);
    } else {
      selectedFlats = selectedFlats.filter(f => f.sn !== sn || f.flat !== flat.flat);
    }
    if (selectedFlats.length > 0) {
      document.getElementById("addBtnDiv").classList.remove("hidden");
    } else {
      document.getElementById("addBtnDiv").classList.add("hidden");
      document.getElementById("maintenanceForm").classList.add("hidden");
    }
  }

  // Show Add Maintenance Form
  function showForm() {
    const formTable = document.getElementById("formFlatRow");
    formTable.innerHTML = "";

    selectedFlats.forEach(f => {
      formTable.innerHTML += `
        <tr>
          <td>${f.flat}</td>
          <td>${f.customer}</td>
          <td>${f.size}</td>
          <td>${f.soldAmt}</td>
          <td>${f.recvAmt}</td>
          <td>${f.date}</td>
        </tr>
      `;
    });

    document.getElementById("maintAmount").value = "";
    document.getElementById("maintDate").value = "";
    document.getElementById("maintDetails").value = "";

    document.getElementById("flatHeader").classList.add("hidden");
    document.getElementById("tabsDiv").classList.add("hidden");
    document.getElementById("flatTable").classList.add("hidden");
    document.getElementById("addBtnDiv").classList.add("hidden");

    document.getElementById("maintenanceForm").classList.remove("hidden");
  }

  // Back Button
  function backToFlats() {
    document.getElementById("maintenanceForm").classList.add("hidden");
    document.getElementById("flatHeader").classList.remove("hidden");
    document.getElementById("tabsDiv").classList.remove("hidden");
    document.getElementById("flatTable").classList.remove("hidden");
    if (selectedFlats.length > 0) {
      document.getElementById("addBtnDiv").classList.remove("hidden");
    }
  }

  function addMaintenance() {
    document.getElementById("maintAmount").value = "";
    document.getElementById("maintDate").value = "";
    document.getElementById("maintDetails").value = "";
  }

  // ✅ Search Function
  function applySearch() {
    const fromDate = document.getElementById("fromDate").value;
    const toDate = document.getElementById("toDate").value;
    const site = document.getElementById("siteSelect").value;

    let project = site === "all" ? Object.keys(flats) : [site];
    let tbody = document.getElementById("flatBody");
    tbody.innerHTML = "";
    selectedFlats = [];

    project.forEach(p => {
      flats[p].forEach(f => {
        let soldDate = new Date(f.date);
        let from = fromDate ? new Date(fromDate) : null;
        let to = toDate ? new Date(toDate) : null;

        if ((from && soldDate < from) || (to && soldDate > to)) return;

        tbody.innerHTML += `
          <tr>
            <td>${f.sn}</td>
            <td>${f.flat}</td>
            <td>${f.customer}</td>
            <td>${f.size}</td>
            <td>${f.date}</td>
            <td>${f.lastDate}</td>
            <td>${f.amount}</td>
            <td><input type="checkbox" onclick="toggleFlat('${p}', ${f.sn}, this)"></td>
          </tr>
        `;
      });
    });
  }
</script>

<%-include('footer.ejs')%>
